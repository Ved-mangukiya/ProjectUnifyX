<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional Typing Speed Test</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #6366f1;
            --primary-hover: #4f46e5;
            --success-color: #10b981;
            --error-color: #ef4444;
            --warning-color: #f59e0b;
            --bg-color: #f8fafc;
            --card-bg: #ffffff;
            --text-color: #1e293b;
            --text-muted: #64748b;
            --border-color: #e2e8f0;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            --gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        [data-theme="dark"] {
            --bg-color: #0f172a;
            --card-bg: #1e293b;
            --text-color: #f1f5f9;
            --text-muted: #94a3b8;
            --border-color: #334155;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            transition: all 0.3s ease;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            animation: fadeInDown 0.8s ease;
        }

        .header h1 {
            font-size: 3rem;
            margin-bottom: 15px;
            background: var(--gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 800;
        }

        .header p {
            font-size: 1.2rem;
            color: var(--text-muted);
        }

        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .control-section {
            background: var(--card-bg);
            padding: 25px;
            border-radius: 15px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
        }

        .control-section h3 {
            margin-bottom: 15px;
            color: var(--primary-color);
            font-size: 1.1rem;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-color);
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background: var(--card-bg);
            color: var(--text-color);
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-hover);
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .btn-secondary {
            background: var(--card-bg);
            color: var(--text-color);
            border: 2px solid var(--border-color);
        }

        .btn-secondary:hover {
            border-color: var(--primary-color);
            color: var(--primary-color);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
        }

        .test-area {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-color);
            min-height: 400px;
            position: relative;
            overflow: hidden;
        }

        .countdown {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 6rem;
            font-weight: 900;
            color: var(--primary-color);
            animation: pulse 1s infinite;
            z-index: 10;
        }

        @keyframes pulse {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.1); }
        }

        .text-display {
            font-family: 'JetBrains Mono', 'Fira Code', 'Courier New', monospace;
            font-size: 1.3rem;
            line-height: 2.2;
            margin-bottom: 25px;
            padding: 25px;
            background: var(--bg-color);
            border-radius: 12px;
            border-left: 5px solid var(--primary-color);
            letter-spacing: 0.5px;
            min-height: 200px;
            position: relative;
            overflow: hidden;
            user-select: none;
        }

        .text-lines {
            transition: transform 0.5s ease;
        }

        .text-line {
            margin-bottom: 10px;
            opacity: 1;
            transition: opacity 0.3s ease;
        }

        .text-line.faded {
            opacity: 0.3;
        }

        .char {
            position: relative;
            transition: all 0.15s ease;
            border-radius: 3px;
            padding: 2px 1px;
        }

        .char.correct {
            background-color: var(--success-color);
            color: white;
        }

        .char.incorrect {
            background-color: var(--error-color);
            color: white;
            animation: shake 0.3s ease;
        }

        .char.current {
            background-color: var(--primary-color);
            color: white;
            animation: blink 1.2s infinite;
        }

        .char.extra {
            background-color: var(--warning-color);
            color: white;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.4; }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-2px); }
            75% { transform: translateX(2px); }
        }

        .typing-input {
            position: absolute;
            opacity: 0;
            pointer-events: none;
        }

        .progress-container {
            margin: 20px 0;
        }

        .progress-bar {
            width: 100%;
            height: 10px;
            background: var(--border-color);
            border-radius: 5px;
            overflow: hidden;
            position: relative;
        }
        footer {
    color: var(--text-color);
    text-align: center;
    padding: 15px;
    margin-top: 20px;
    border-radius: 0 0 15px 15px;
    background: var(--card-bg);
    box-shadow: var(--shadow);
    border: 1px solid var(--border-color);
}

footer p {
    font-size: 0.9rem;
}

        .progress-fill {
            height: 100%;
            background: var(--gradient);
            border-radius: 5px;
            transition: width 0.3s ease;
            width: 0%;
            position: relative;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--card-bg);
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--gradient);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 900;
            color: var(--primary-color);
            margin-bottom: 8px;
            font-family: 'JetBrains Mono', monospace;
        }

        .stat-label {
            color: var(--text-muted);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            font-weight: 600;
        }

        .timer-display {
            text-align: center;
            margin: 20px 0;
        }

        .timer-value {
            font-size: 3rem;
            font-weight: 900;
            color: var(--primary-color);
            font-family: 'JetBrains Mono', monospace;
        }

        .results {
            background: var(--card-bg);
            padding: 40px;
            border-radius: 15px;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-color);
            text-align: center;
            animation: fadeInUp 0.6s ease;
        }

        .results h2 {
            font-size: 2.5rem;
            margin-bottom: 30px;
            color: var(--success-color);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .leaderboard {
            background: var(--card-bg);
            padding: 30px;
            border-radius: 15px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            margin-top: 30px;
        }

        .leaderboard h3 {
            text-align: center;
            margin-bottom: 25px;
            color: var(--primary-color);
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .leaderboard-entry {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            margin-bottom: 12px;
            background: var(--bg-color);
            border-radius: 10px;
            border-left: 4px solid var(--primary-color);
            transition: all 0.3s ease;
        }

        .leaderboard-entry:hover {
            transform: translateX(5px);
            box-shadow: var(--shadow);
        }

        .leaderboard-entry:first-child {
            border-left-color: var(--warning-color);
            background: linear-gradient(90deg, rgba(245, 158, 11, 0.1), var(--bg-color));
        }

        .custom-text-area {
            min-height: 150px;
            resize: vertical;
            font-family: 'JetBrains Mono', monospace;
        }

        .hidden {
            display: none !important;
        }

        .fade-enter {
            opacity: 0;
            transform: translateY(20px);
        }

        .fade-enter-active {
            opacity: 1;
            transform: translateY(0);
            transition: all 0.5s ease;
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-40px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(40px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .sound-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--card-bg);
            border: 2px solid var(--border-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow);
            z-index: 1000;
        }

        .sound-toggle:hover {
            border-color: var(--primary-color);
            transform: scale(1.1);
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 2.2rem;
            }
            
            .controls-grid {
                grid-template-columns: 1fr;
            }
            
            .text-display {
                font-size: 1.1rem;
                line-height: 1.8;
                padding: 20px;
            }
            
            .stats {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .btn-grid {
                grid-template-columns: 1fr;
            }

            .countdown {
                font-size: 4rem;
            }

            .timer-value {
                font-size: 2rem;
            }

            .stat-value {
                font-size: 2rem;
            }
        }

        .mode-indicator {
            position: absolute;
            top: 15px;
            right: 15px;
            padding: 8px 12px;
            background: var(--primary-color);
            color: white;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .words-per-line {
            max-width: 80ch;
        }
        
    </style>
</head>
<body>
    <div class="sound-toggle" id="soundToggle" title="Toggle typing sounds">
        🔊
    </div>

    <div class="container">
        <div class="header">
            <h1>⚡ Professional Typing Master</h1>
            <p>Advanced typing speed test with customizable features and real-time feedback</p>
        </div>

        <div class="controls-grid">
            <div class="control-section">
                <h3>🎯 Test Settings</h3>
                <div class="form-group">
                    <label for="testMode">Test Mode:</label>
                    <select id="testMode" class="form-control">
                        <option value="time">Time-based Test</option>
                        <option value="words">Word Count Test</option>
                        <option value="custom">Custom Text</option>
                    </select>
                </div>
                <div class="form-group" id="timeSettings">
                    <label for="testDuration">Duration (seconds):</label>
                    <select id="testDuration" class="form-control">
                        <option value="15">15 seconds</option>
                        <option value="30">30 seconds</option>
                        <option value="60" selected>1 minute</option>
                        <option value="120">2 minutes</option>
                        <option value="300">5 minutes</option>
                        <option value="custom">Custom</option>
                    </select>
                    <input type="number" id="customTime" class="form-control hidden" placeholder="Enter seconds" min="10" max="3600">
                </div>
                <div class="form-group hidden" id="wordSettings">
                    <label for="wordCount">Word Count:</label>
                    <select id="wordCount" class="form-control">
                        <option value="25">25 words</option>
                        <option value="50">50 words</option>
                        <option value="100">100 words</option>
                        <option value="200">200 words</option>
                    </select>
                </div>
            </div>

            <div class="control-section">
                <h3>📝 Text Options</h3>
                <div class="form-group">
                    <label for="difficulty">Difficulty:</label>
                    <select id="difficulty" class="form-control">
                        <option value="easy">Easy (Common words)</option>
                        <option value="medium" selected>Medium (Mixed text)</option>
                        <option value="hard">Hard (Complex text)</option>
                        <option value="programming">Programming</option>
                        <option value="numbers">Numbers & Symbols</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="language">Language:</label>
                    <select id="language" class="form-control">
                        <option value="english" selected>English</option>
                        <option value="quotes">Famous Quotes</option>
                        <option value="literature">Literature</option>
                        <option value="technical">Technical</option>
                    </select>
                </div>
            </div>

            <div class="control-section" id="customTextSection">
                <h3>✏️ Custom Text</h3>
                <div class="form-group">
                    <label for="customText">Paste your text here:</label>
                    <textarea id="customText" class="form-control custom-text-area" placeholder="Enter or paste your custom text here..."></textarea>
                </div>
            </div>

            <div class="control-section">
                <h3>⚙️ Advanced Options</h3>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="showKeyboard" checked> Show virtual keyboard
                    </label>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="strictMode"> Strict mode (stop on error)
                    </label>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="blindMode"> Blind mode (hide text)
                    </label>
                </div>
                <div class="btn-grid">
                    <button class="btn btn-primary" id="startTest">🚀 Start Test</button>
                    <button class="btn btn-secondary" id="resetTest">🔄 Reset</button>
                    <button class="btn btn-secondary" id="themeToggle">🌙 Dark</button>
                </div>
            </div>
        </div>

        <div class="test-area" id="testArea">
            <div class="mode-indicator" id="modeIndicator">TIME MODE</div>
            <div id="countdown" class="countdown hidden">3</div>
            
            <div class="timer-display" id="timerDisplay">
                <div class="timer-value" id="timerValue">60</div>
            </div>
            
            <div id="textDisplay" class="text-display">
                <div class="text-lines" id="textLines"></div>
            </div>
            
            <div class="progress-container">
                <div class="progress-bar">
                    <div id="progressFill" class="progress-fill"></div>
                </div>
            </div>
            
            <input type="text" id="typingInput" class="typing-input" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
        </div>

        <div class="stats">
            <div class="stat-card">
                <div id="wpmValue" class="stat-value">0</div>
                <div class="stat-label">WPM</div>
            </div>
            <div class="stat-card">
                <div id="rawWpmValue" class="stat-value">0</div>
                <div class="stat-label">Raw WPM</div>
            </div>
            <div class="stat-card">
                <div id="accuracyValue" class="stat-value">100%</div>
                <div class="stat-label">Accuracy</div>
            </div>
            <div class="stat-card">
                <div id="errorsValue" class="stat-value">0</div>
                <div class="stat-label">Errors</div>
            </div>
            <div class="stat-card">
                <div id="timeValue" class="stat-value">0s</div>
                <div class="stat-label">Time</div>
            </div>
            <div class="stat-card">
                <div id="consistencyValue" class="stat-value">100%</div>
                <div class="stat-label">Consistency</div>
            </div>
        </div>

        <div id="results" class="results hidden">
            <h2>🎉 Test Complete!</h2>
            <div class="stats">
                <div class="stat-card">
                    <div id="finalWpm" class="stat-value">0</div>
                    <div class="stat-label">Final WPM</div>
                </div>
                <div class="stat-card">
                    <div id="finalAccuracy" class="stat-value">100%</div>
                    <div class="stat-label">Final Accuracy</div>
                </div>
                <div class="stat-card">
                    <div id="finalTime" class="stat-value">0s</div>
                    <div class="stat-label">Total Time</div>
                </div>
                <div class="stat-card">
                    <div id="finalConsistency" class="stat-value">100%</div>
                    <div class="stat-label">Consistency</div>
                </div>
            </div>
        </div>

        <div class="leaderboard">
            <h3>🏆 Personal Best Records</h3>
            <div id="leaderboardList">
                <div class="leaderboard-entry">
                    <span>No records yet - Start your first test!</span>
                    <span>--</span>
                </div>
            </div>
        </div>
    </div>
    <footer>
    <p>© <span id="current-year"></span> Mangukiya Ved. All rights reserved.</p>
</footer>

    <script>
        class AdvancedTypingTest {
            constructor() {
                this.texts = {
                    easy: [
                        "the quick brown fox jumps over the lazy dog near the river",
                        "a good book can change your life and open new doors for you",
                        "every morning brings new hope and fresh opportunities to grow",
                        "simple words can carry the most powerful messages in life"
                    ],
                    medium: [
                        "Technology has revolutionized the way we communicate and work in modern society",
                        "The journey of a thousand miles begins with a single step forward into the unknown",
                        "Success requires dedication, persistence, and the courage to face challenges head-on",
                        "Innovation distinguishes between leaders and followers in competitive markets today"
                    ],
                    hard: [
                        "Artificial intelligence and machine learning algorithms are transforming industries at an unprecedented pace",
                        "Quantum computing represents a paradigm shift that could solve previously intractable computational problems",
                        "Sustainable development requires balancing economic growth with environmental conservation efforts",
                        "Globalization has created interconnected economies that are both resilient and vulnerable simultaneously"
                    ],
                    programming: [
                        "function calculateSum(array) { return array.reduce((a, b) => a + b, 0); }",
                        "const promise = new Promise((resolve, reject) => { setTimeout(resolve, 1000); });",
                        "class Component extends React.Component { render() { return <div>Hello World</div>; } }",
                        "SELECT * FROM users WHERE age > 18 AND status = 'active' ORDER BY created_at DESC;"
                    ],
                    numbers: [
                        "Phone: +1-555-123-4567, Email: user@example.com, Price: $29.99",
                        "API Key: abc123-def456-ghi789, Version: 2.1.0, Port: 8080",
                        "Coordinates: (40.7128, -74.0060), Temperature: 72.5°F, Humidity: 65%",
                        "Invoice #INV-2024-001: $1,234.56 due on 12/31/2024 at 11:59 PM"
                    ]
                };

                this.quotes = [
                    "The only way to do great work is to love what you do. - Steve Jobs",
                    "Life is what happens to you while you're busy making other plans. - John Lennon",
                    "The future belongs to those who believe in the beauty of their dreams. - Eleanor Roosevelt",
                    "Innovation distinguishes between a leader and a follower. - Steve Jobs"
                ];

                this.currentText = '';
                this.currentWords = [];
                this.currentPosition = 0;
                this.currentLine = 0;
                this.wordsPerLine = 12;
                this.visibleLines = 3;
                
                this.startTime = null;
                this.endTime = null;
                this.testDuration = 60;
                this.isStarted = false;
                this.isCompleted = false;
                this.isPaused = false;
                
                this.stats = {
                    wpm: 0,
                    rawWpm: 0,
                    accuracy: 100,
                    errors: 0,
                    time: 0,
                    consistency: 100,
                    correctChars: 0,
                    totalChars: 0,
                    wpmHistory: []
                };

                this.timer = null;
                this.soundEnabled = true;
                this.strictMode = false;
                this.blindMode = false;

                this.initializeElements();
                this.bindEvents();
                this.loadSettings();
                this.generateNewTest();
            }

            initializeElements() {
                // Controls
                this.testModeSelect = document.getElementById('testMode');
                this.testDurationSelect = document.getElementById('testDuration');
                this.customTimeInput = document.getElementById('customTime');
                this.wordCountSelect = document.getElementById('wordCount');
                this.difficultySelect = document.getElementById('difficulty');
                this.languageSelect = document.getElementById('language');
                this.customTextArea = document.getElementById('customText');
                this.customTextSection = document.getElementById('customTextSection');
                
                // Test area
                this.testArea = document.getElementById('testArea');
                this.modeIndicator = document.getElementById('modeIndicator');
                this.countdownDiv = document.getElementById('countdown');
                this.timerDisplay = document.getElementById('timerDisplay');
                this.timerValue = document.getElementById('timerValue');
                this.textDisplay = document.getElementById('textDisplay');
                this.textLines = document.getElementById('textLines');
                this.typingInput = document.getElementById('typingInput');
                this.progressFill = document.getElementById('progressFill');
                
                // Stats
                this.wpmValue = document.getElementById('wpmValue');
                this.rawWpmValue = document.getElementById('rawWpmValue');
                this.accuracyValue = document.getElementById('accuracyValue');
                this.errorsValue = document.getElementById('errorsValue');
                this.timeValue = document.getElementById('timeValue');
                this.consistencyValue = document.getElementById('consistencyValue');
                
                // Results
                this.resultsDiv = document.getElementById('results');
                this.finalWpm = document.getElementById('finalWpm');
                this.finalAccuracy = document.getElementById('finalAccuracy');
                this.finalTime = document.getElementById('finalTime');
                this.finalConsistency = document.getElementById('finalConsistency');
                
                // Controls
                this.startBtn = document.getElementById('startTest');
                this.resetBtn = document.getElementById('resetTest');
                this.themeToggle = document.getElementById('themeToggle');
                this.soundToggle = document.getElementById('soundToggle');
                this.strictModeCheck = document.getElementById('strictMode');
                this.blindModeCheck = document.getElementById('blindMode');
                
                this.leaderboardList = document.getElementById('leaderboardList');
                this.timeSettings = document.getElementById('timeSettings');
                this.wordSettings = document.getElementById('wordSettings');
            }

            bindEvents() {
                this.testModeSelect.addEventListener('change', () => this.handleModeChange());
                this.testDurationSelect.addEventListener('change', () => this.handleDurationChange());
                this.startBtn.addEventListener('click', () => this.startTest());
                this.resetBtn.addEventListener('click', () => this.resetTest());
                this.themeToggle.addEventListener('click', () => this.toggleTheme());
                this.soundToggle.addEventListener('click', () => this.toggleSound());
                
                this.typingInput.addEventListener('input', (e) => this.handleTyping(e));
                this.typingInput.addEventListener('keydown', (e) => this.handleKeydown(e));
                this.typingInput.addEventListener('paste', (e) => this.handlePaste(e));
                
                this.strictModeCheck.addEventListener('change', (e) => this.strictMode = e.target.checked);
                this.blindModeCheck.addEventListener('change', (e) => this.handleBlindMode(e.target.checked));
                
                this.difficultySelect.addEventListener('change', () => this.generateNewTest());
                this.languageSelect.addEventListener('change', () => this.generateNewTest());
                this.customTextArea.addEventListener('input', () => this.generateNewTest());
                
                // Click to focus
                this.textDisplay.addEventListener('click', () => {
                    if (!this.isCompleted) {
                        this.typingInput.focus();
                    }
                });

                // Prevent losing focus
                document.addEventListener('click', (e) => {
                    if (this.isStarted && !this.isCompleted && !e.target.closest('.control-section')) {
                        this.typingInput.focus();
                    }
                });
            }

            handleModeChange() {
                const mode = this.testModeSelect.value;
                this.timeSettings.classList.toggle('hidden', mode !== 'time');
                this.wordSettings.classList.toggle('hidden', mode !== 'words');
                this.customTextSection.classList.toggle('hidden', mode !== 'custom');
                
                this.modeIndicator.textContent = mode.toUpperCase() + ' MODE';
                this.generateNewTest();
            }

            handleDurationChange() {
                if (this.testDurationSelect.value === 'custom') {
                    this.customTimeInput.classList.remove('hidden');
                    this.customTimeInput.focus();
                } else {
                    this.customTimeInput.classList.add('hidden');
                    this.testDuration = parseInt(this.testDurationSelect.value);
                    this.timerValue.textContent = this.testDuration;
                }
            }

            handleBlindMode(enabled) {
                this.blindMode = enabled;
                this.textDisplay.style.filter = enabled ? 'blur(5px)' : 'none';
            }

            generateNewTest() {
                this.resetTest();
                const mode = this.testModeSelect.value;
                
                if (mode === 'custom') {
                    this.currentText = this.customTextArea.value.trim() || "Please enter your custom text above to start the test.";
                } else {
                    this.currentText = this.generateText();
                }
                
                this.prepareText();
                this.renderText();
                this.updateModeSettings();
            }

            generateText() {
                const difficulty = this.difficultySelect.value;
                const language = this.languageSelect.value;
                const mode = this.testModeSelect.value;
                
                let sourceTexts = [];
                
                if (language === 'quotes') {
                    sourceTexts = this.quotes;
                } else {
                    sourceTexts = this.texts[difficulty] || this.texts.medium;
                }
                
                if (mode === 'words') {
                    const wordCount = parseInt(this.wordCountSelect.value);
                    return this.generateWordCountText(sourceTexts, wordCount);
                } else {
                    // For time mode, use longer text
                    return sourceTexts[Math.floor(Math.random() * sourceTexts.length)];
                }
            }

            generateWordCountText(sourceTexts, targetWords) {
                let result = '';
                let wordCount = 0;
                
                while (wordCount < targetWords) {
                    const text = sourceTexts[Math.floor(Math.random() * sourceTexts.length)];
                    const words = text.split(' ');
                    
                    for (const word of words) {
                        if (wordCount >= targetWords) break;
                        result += (wordCount > 0 ? ' ' : '') + word;
                        wordCount++;
                    }
                }
                
                return result;
            }

            prepareText() {
                this.currentWords = this.currentText.split(' ');
                this.currentPosition = 0;
                this.currentLine = 0;
            }

            renderText() {
                const lines = this.createLines();
                this.textLines.innerHTML = '';
                
                lines.forEach((line, lineIndex) => {
                    const lineDiv = document.createElement('div');
                    lineDiv.className = 'text-line';
                    lineDiv.innerHTML = line.map((word, wordIndex) => {
                        const globalWordIndex = this.getGlobalWordIndex(lineIndex, wordIndex);
                        return word.split('').map((char, charIndex) => {
                            const globalCharIndex = this.getGlobalCharIndex(globalWordIndex, charIndex);
                            return `<span class="char" data-index="${globalCharIndex}">${char === ' ' ? '&nbsp;' : char}</span>`;
                        }).join('');
                    }).join('<span class="char">&nbsp;</span>');
                    
                    this.textLines.appendChild(lineDiv);
                });
            }

            createLines() {
                const lines = [];
                let currentLine = [];
                let currentLineLength = 0;
                
                for (let i = 0; i < this.currentWords.length; i++) {
                    const word = this.currentWords[i];
                    
                    if (currentLine.length >= this.wordsPerLine || 
                        (currentLineLength + word.length > 60 && currentLine.length > 0)) {
                        lines.push([...currentLine]);
                        currentLine = [word];
                        currentLineLength = word.length;
                    } else {
                        currentLine.push(word);
                        currentLineLength += word.length + (currentLine.length > 1 ? 1 : 0);
                    }
                }
                
                if (currentLine.length > 0) {
                    lines.push(currentLine);
                }
                
                return lines;
            }

            getGlobalWordIndex(lineIndex, wordIndex) {
                let globalIndex = 0;
                const lines = this.createLines();
                
                for (let i = 0; i < lineIndex; i++) {
                    globalIndex += lines[i].length;
                }
                
                return globalIndex + wordIndex;
            }

            getGlobalCharIndex(wordIndex, charIndex) {
                let globalIndex = 0;
                
                for (let i = 0; i < wordIndex; i++) {
                    globalIndex += this.currentWords[i].length + (i > 0 ? 1 : 0);
                }
                
                return globalIndex + charIndex;
            }

            updateModeSettings() {
                const mode = this.testModeSelect.value;
                
                if (mode === 'time') {
                    const duration = this.testDurationSelect.value === 'custom' ? 
                        parseInt(this.customTimeInput.value) || 60 : 
                        parseInt(this.testDurationSelect.value);
                    this.testDuration = duration;
                    this.timerValue.textContent = duration;
                    this.timerDisplay.classList.remove('hidden');
                } else if (mode === 'words') {
                    this.timerDisplay.classList.add('hidden');
                } else {
                    this.timerDisplay.classList.add('hidden');
                }
            }

            async startTest() {
                if (this.isStarted) return;
                
                this.startBtn.disabled = true;
                this.typingInput.disabled = true;
                
                await this.showCountdown();
                
                this.isStarted = true;
                this.startTime = Date.now();
                this.typingInput.disabled = false;
                this.typingInput.focus();
                
                if (this.testModeSelect.value === 'time') {
                    this.startTimer();
                }
                
                this.startBtn.textContent = '⏸️ Pause';
                this.startBtn.disabled = false;
            }

            async showCountdown() {
                this.countdownDiv.classList.remove('hidden');
                
                for (let i = 3; i > 0; i--) {
                    this.countdownDiv.textContent = i;
                    await this.sleep(1000);
                }
                
                this.countdownDiv.textContent = 'GO!';
                await this.sleep(500);
                this.countdownDiv.classList.add('hidden');
            }

            startTimer() {
                this.timer = setInterval(() => {
                    const elapsed = Math.floor((Date.now() - this.startTime) / 1000);
                    const remaining = Math.max(0, this.testDuration - elapsed);
                    
                    this.timerValue.textContent = remaining;
                    
                    if (remaining <= 0) {
                        this.completeTest();
                    }
                }, 100);
            }

            handleKeydown(e) {
                if (!this.isStarted || this.isCompleted) return;
                
                // Prevent certain keys in strict mode
                if (this.strictMode && (e.key === 'Backspace' || e.key === 'Delete')) {
                    e.preventDefault();
                    return;
                }
                
                // Play typing sound
                if (this.soundEnabled && e.key.length === 1) {
                    this.playTypingSound();
                }
            }

            handlePaste(e) {
                e.preventDefault(); // Prevent pasting during test
            }

            handleTyping(e) {
                if (!this.isStarted || this.isCompleted) return;
                
                const typedText = this.typingInput.value;
                const expectedText = this.currentText.substring(0, typedText.length);
                
                this.updateTextHighlighting(typedText);
                this.updateStats(typedText);
                this.updateProgress(typedText.length / this.currentText.length * 100);
                this.handleLineScrolling(typedText);
                
                // Check for completion
                if (typedText.length >= this.currentText.length && 
                    typedText === this.currentText) {
                    this.completeTest();
                }
                
                // Handle strict mode errors
                if (this.strictMode && typedText !== expectedText) {
                    this.typingInput.value = expectedText;
                    this.showError();
                }
            }

            updateTextHighlighting(typedText) {
                const chars = document.querySelectorAll('.char');
                
                chars.forEach((char, index) => {
                    char.classList.remove('correct', 'incorrect', 'current', 'extra');
                    
                    if (index < typedText.length) {
                        if (index < this.currentText.length) {
                            if (typedText[index] === this.currentText[index]) {
                                char.classList.add('correct');
                            } else {
                                char.classList.add('incorrect');
                            }
                        } else {
                            char.classList.add('extra');
                        }
                    } else if (index === typedText.length && index < this.currentText.length) {
                        char.classList.add('current');
                    }
                });
            }

            handleLineScrolling(typedText) {
                const currentCharIndex = typedText.length;
                const lines = this.createLines();
                let currentLine = 0;
                let charCount = 0;
                
                for (let lineIndex = 0; lineIndex < lines.length; lineIndex++) {
                    const lineCharCount = lines[lineIndex].join(' ').length + (lineIndex > 0 ? 1 : 0);
                    
                    if (currentCharIndex <= charCount + lineCharCount) {
                        currentLine = lineIndex;
                        break;
                    }
                    
                    charCount += lineCharCount;
                }
                
                // Fade previous lines and scroll if needed
                const textLineElements = document.querySelectorAll('.text-line');
                textLineElements.forEach((line, index) => {
                    line.classList.toggle('faded', index < currentLine);
                });
                
                // Scroll the text container
                if (currentLine >= this.visibleLines) {
                    const scrollOffset = (currentLine - this.visibleLines + 1) * 60; // 60px per line approx
                    this.textLines.style.transform = `translateY(-${scrollOffset}px)`;
                }
            }

            updateStats(typedText) {
                const now = Date.now();
                const timeElapsed = (now - this.startTime) / 1000;
                
                // Calculate WPM
                const wordsTyped = typedText.length / 5;
                const minutes = timeElapsed / 60;
                const rawWpm = minutes > 0 ? Math.round(wordsTyped / minutes) : 0;
                
                // Calculate accuracy
                let correctChars = 0;
                let errors = 0;
                
                for (let i = 0; i < typedText.length; i++) {
                    if (i < this.currentText.length && typedText[i] === this.currentText[i]) {
                        correctChars++;
                    } else {
                        errors++;
                    }
                }
                
                const accuracy = typedText.length > 0 ? Math.round((correctChars / typedText.length) * 100) : 100;
                const wpm = Math.round(rawWpm * (accuracy / 100));
                
                // Calculate consistency
                this.stats.wpmHistory.push(rawWpm);
                if (this.stats.wpmHistory.length > 10) {
                    this.stats.wpmHistory.shift();
                }
                
                const consistency = this.calculateConsistency();
                
                // Update stats object
                this.stats = {
                    wpm,
                    rawWpm,
                    accuracy,
                    errors,
                    time: Math.round(timeElapsed),
                    consistency,
                    correctChars,
                    totalChars: typedText.length,
                    wpmHistory: this.stats.wpmHistory
                };
                
                // Update UI
                this.wpmValue.textContent = wpm;
                this.rawWpmValue.textContent = rawWpm;
                this.accuracyValue.textContent = accuracy + '%';
                this.errorsValue.textContent = errors;
                this.timeValue.textContent = Math.round(timeElapsed) + 's';
                this.consistencyValue.textContent = consistency + '%';
            }

            calculateConsistency() {
                if (this.stats.wpmHistory.length < 2) return 100;
                
                const avg = this.stats.wpmHistory.reduce((a, b) => a + b) / this.stats.wpmHistory.length;
                const variance = this.stats.wpmHistory.reduce((sum, wpm) => sum + Math.pow(wpm - avg, 2), 0) / this.stats.wpmHistory.length;
                const stdDev = Math.sqrt(variance);
                
                return Math.max(0, Math.round(100 - (stdDev / avg * 100)));
            }

            updateProgress(percentage) {
                this.progressFill.style.width = Math.min(100, percentage) + '%';
            }

            showError() {
                this.testArea.style.animation = 'shake 0.3s ease';
                setTimeout(() => {
                    this.testArea.style.animation = '';
                }, 300);
            }

            completeTest() {
                this.isCompleted = true;
                this.endTime = Date.now();
                
                if (this.timer) {
                    clearInterval(this.timer);
                }
                
                this.typingInput.disabled = true;
                this.startBtn.textContent = '🚀 Start Test';
                this.startBtn.disabled = false;
                
                // Update final stats
                this.finalWpm.textContent = this.stats.wpm;
                this.finalAccuracy.textContent = this.stats.accuracy + '%';
                this.finalTime.textContent = this.stats.time + 's';
                this.finalConsistency.textContent = this.stats.consistency + '%';
                
                this.resultsDiv.classList.remove('hidden');
                this.saveScore();
                this.updateLeaderboard();
            }

            resetTest() {
                this.isStarted = false;
                this.isCompleted = false;
                this.isPaused = false;
                this.currentPosition = 0;
                this.currentLine = 0;
                
                if (this.timer) {
                    clearInterval(this.timer);
                }
                
                this.typingInput.value = '';
                this.typingInput.disabled = false;
                this.startBtn.textContent = '🚀 Start Test';
                this.startBtn.disabled = false;
                
                this.resultsDiv.classList.add('hidden');
                this.countdownDiv.classList.add('hidden');
                
                this.stats = {
                    wpm: 0,
                    rawWpm: 0,
                    accuracy: 100,
                    errors: 0,
                    time: 0,
                    consistency: 100,
                    correctChars: 0,
                    totalChars: 0,
                    wpmHistory: []
                };
                
                this.updateStats('');
                this.updateProgress(0);
                this.updateModeSettings();
                
                // Reset text highlighting
                document.querySelectorAll('.char').forEach(char => {
                    char.classList.remove('correct', 'incorrect', 'current', 'extra');
                });
                
                // Reset text scrolling
                this.textLines.style.transform = 'translateY(0)';
                document.querySelectorAll('.text-line').forEach(line => {
                    line.classList.remove('faded');
                });
                
                this.typingInput.focus();
            }

            saveScore() {
                const scores = this.getScores();
                const newScore = {
                    wpm: this.stats.wpm,
                    rawWpm: this.stats.rawWpm,
                    accuracy: this.stats.accuracy,
                    consistency: this.stats.consistency,
                    time: this.stats.time,
                    date: new Date().toLocaleDateString(),
                    mode: this.testModeSelect.value,
                    difficulty: this.difficultySelect.value,
                    language: this.languageSelect.value
                };
                
                scores.push(newScore);
                scores.sort((a, b) => b.wpm - a.wpm);
                scores.splice(10); // Keep top 10
                
                localStorage.setItem('advancedTypingScores', JSON.stringify(scores));
            }

            getScores() {
                const scores = localStorage.getItem('advancedTypingScores');
                return scores ? JSON.parse(scores) : [];
            }

            updateLeaderboard() {
                const scores = this.getScores();
                
                if (scores.length === 0) {
                    this.leaderboardList.innerHTML = `
                        <div class="leaderboard-entry">
                            <span>No records yet - Start your first test!</span>
                            <span>--</span>
                        </div>
                    `;
                    return;
                }
                
                this.leaderboardList.innerHTML = scores
                    .slice(0, 5)
                    .map((score, index) => `
                        <div class="leaderboard-entry">
                            <span>
                                ${index + 1}. ${score.wpm} WPM 
                                (${score.accuracy}% acc, ${score.consistency}% cons)
                                <small>${score.mode} - ${score.difficulty}</small>
                            </span>
                            <span>${score.date}</span>
                        </div>
                    `).join('');
            }

            toggleTheme() {
                const currentTheme = document.body.getAttribute('data-theme');
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                
                document.body.setAttribute('data-theme', newTheme);
                this.themeToggle.textContent = newTheme === 'dark' ? '☀️ Light' : '🌙 Dark';
                
                localStorage.setItem('advancedTypingTheme', newTheme);
            }

            toggleSound() {
                this.soundEnabled = !this.soundEnabled;
                this.soundToggle.textContent = this.soundEnabled ? '🔊' : '🔇';
                this.soundToggle.title = this.soundEnabled ? 'Disable typing sounds' : 'Enable typing sounds';
                
                localStorage.setItem('typingSoundEnabled', this.soundEnabled);
            }

            playTypingSound() {
                // Create a simple click sound using Web Audio API
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.1);
            }

            loadSettings() {
                document.getElementById('current-year').textContent = new Date().getFullYear();
                // Load theme
                const savedTheme = localStorage.getItem('advancedTypingTheme') || 'light';
                document.body.setAttribute('data-theme', savedTheme);
                this.themeToggle.textContent = savedTheme === 'dark' ? '☀️ Light' : '🌙 Dark';
                
                // Load sound setting
                const soundEnabled = localStorage.getItem('typingSoundEnabled');
                if (soundEnabled !== null) {
                    this.soundEnabled = soundEnabled === 'true';
                    this.soundToggle.textContent = this.soundEnabled ? '🔊' : '🔇';
                }
                
                this.updateLeaderboard();
            }

            sleep(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
        }

        // Initialize the advanced typing test
        document.addEventListener('DOMContentLoaded', () => {
            new AdvancedTypingTest();
        });
    </script>
</body>
</html>