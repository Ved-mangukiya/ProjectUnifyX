
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#181139">
    <title>Question Paper Maker</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
    <script src="https://mozilla.github.io/pdf.js/build/pdf.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Times New Roman', serif;
        }

        body {
            background-color: #333333;
            color: #e9ecef;
            margin: 0;
            padding: 0;
            line-height: 1.6;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
        }

        .main-container {
            background: #454545;
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
        }

        .tabs {
            display: flex;
            border-bottom: 2px solid #333;
            margin-bottom: 1rem;
            overflow-x: auto;
        }

        .tab {
            padding: 0.75rem 1.25rem;
            cursor: pointer;
            background: transparent;
            border: none;
            color: #a0aec0;
            font-weight: 600;
            transition: color 0.3s ease;
            white-space: nowrap;
        }

        .tab:hover, .tab.active {
            color: #d1b65c;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #e9ecef;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 0.5rem;
            border-radius: 0.5rem;
            border: 1px solid #333;
            background: #545454;
            color: #e9ecef;
            font-size: 0.9rem;
            outline: none;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            border-color: #d1b65c;
        }

        .form-group input.invalid, .form-group select.invalid, .form-group textarea.invalid {
            border-color: #ff6b6b;
        }

        .btn {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            border: none;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .btn-primary {
            background: #d1b65c;
            color: #333333;
        }

        .btn-primary:hover {
            background: #c0a653;
        }

        .btn-secondary {
            background: #b55c5c;
            color: #e9ecef;
        }

        .btn-secondary:hover {
            background: #a34d4d;
        }

        .question-container {
            background: #545454;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
            transition: transform 0.2s ease;
        }

        .question-container.dragging {
            opacity: 0.5;
            transform: scale(0.98);
        }

        .preview-container {
            background: white;
            padding: 15mm;
            border-radius: 0.75rem;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
            color: black;
            width: 100%;
            min-height: 297mm;
            box-sizing: border-box;
            font-size: 12pt;
            border: 1px solid #333333;
            transform-origin: top left;
        }

        .paper-header {
            text-align: center;
            margin-bottom: 20mm;
            border-bottom: 2px solid #333;
            padding-bottom: 10px;
        }

        .paper-title {
            font-size: 16pt;
            font-weight: bold;
            margin: 0;
        }

        .paper-subtitle {
            font-size: 10pt;
            margin: 5px 0 0;
        }

        .paper-question {
            margin-bottom: 15mm;
            page-break-inside: avoid;
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 10px;
            align-items: start;
        }

        .paper-question img {
            max-width: 60%;
            height: auto;
        }

        .question-number {
            font-weight: bold;
            margin-right: 5px;
        }

        .modal {
            position: fixed;
            inset: 0;
            background: rgba(24, 17, 57, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: #333333;
            border-radius: 1rem;
            padding: 1.5rem;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .notification {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            padding: 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            transition: opacity 0.3s ease;
        }

        .notification.success {
            background: #d1b65c;
            color: #333333;
        }

        .notification.error {
            background: #ff6b6b;
            color: #e9ecef;
        }

        .zoom-controls {
            position: absolute;
            top: 1rem;
            right: 1rem;
            display: flex;
            gap: 0.5rem;
        }

        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            transition: opacity 0.3s ease;
        }

        .loading-screen.active {
            display: flex;
            opacity: 1;
        }

        .loading-container {
            text-align: center;
            padding: 2rem;
            background: #fff;
            border-radius: 1rem;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
        }

        .loading-text {
            font-size: 1.5rem;
            color: #333;
            margin-bottom: 1rem;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #d1b65c;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .container {
                padding: 0.5rem;
            }
            .preview-container {
                transform: scale(0.35);
            }
            .form-grid {
                grid-template-columns: 1fr;
            }
            .main-container {
                padding: 1rem;
            }
        }
    </style>
</head>
<body>
    <header class="bg-181139 py-4 shadow-lg">
        <div class="container">
            <h1 class="text-2xl font-bold text-center text-e9ecef">Question Paper Maker</h1>
        </div>
    </header>

    <div class="container">
        <div class="main-container">
            <div class="tabs">
                <button class="tab active" data-tab="setup">Setup Paper</button>
                <button class="tab" data-tab="questions">Add Questions</button>
                <button class="tab" data-tab="preview">Preview</button>
            </div>

            <div class="tab-content active" id="setup-tab">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="schoolName">School Name:</label>
                        <input type="text" id="schoolName" placeholder="Enter school name" maxlength="100">
                    </div>
                    <div class="form-group">
                        <label for="subject">Subject:</label>
                        <input type="text" id="subject" placeholder="Enter subject name" required maxlength="50">
                    </div>
                    <div class="form-group">
                        <label for="chapter">Chapter/Topic:</label>
                        <input type="text" id="chapter" placeholder="Enter chapter or topic" maxlength="50">
                    </div>
                    <div class="form-group">
                        <label for="examName">Exam Name:</label>
                        <input type="text" id="examName" placeholder="e.g., Semester-1" maxlength="50">
                    </div>
                    <div class="form-group">
                        <label for="marks">Total Marks:</label>
                        <input type="number" id="marks" min="1" placeholder="Enter total marks" required>
                    </div>
                    <div class="form-group">
                        <label for="duration">Duration:</label>
                        <input type="text" id="duration" placeholder="e.g., 2 hours" required>
                    </div>
                    <div class="form-group">
                        <label for="examDate">Exam Date:</label>
                        <input type="date" id="examDate" required>
                    </div>
                    <div class="form-group">
                        <label for="paperType">Paper Type:</label>
                        <select id="paperType" required>
                            <option value="short">Short/Long Questions</option>
                            <option value="mcq">Multiple Choice Questions</option>
                            <option value="mixed">Mixed Format</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="headerStyle">Header Style:</label>
                        <select id="headerStyle">
                            <option value="classic">Classic</option>
                            <option value="modern">Modern</option>
                            <option value="minimal">Minimal</option>
                            <option value="traditional" selected>Traditional</option>
                            <option value="academic">Academic</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="paperStyle">Paper Style:</label>
                        <select id="paperStyle">
                            <option value="standard">Standard</option>
                            <option value="compact">Compact</option>
                            <option value="detailed">Detailed</option>
                            <option value="formal">Formal</option>
                            <option value="structured" selected>Structured</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="fontStyle">Font Style:</label>
                        <select id="fontStyle">
                            <option value="Times New Roman" selected>Times New Roman</option>
                            <option value="Arial">Arial</option>
                            <option value="Georgia">Georgia</option>
                            <option value="Garamond">Garamond</option>
                            <option value="Courier New">Courier New</option>
                        </select>
                    </div>
                </div>
                <div class="mt-4">
                    <h3 class="text-lg font-semibold text-e9ecef">Quick Subject Templates:</h3>
                    <div class="flex flex-wrap gap-2 mt-2">
                        <button class="btn btn-primary" onclick="loadTemplate('A/C')">A/C</button>
                        <button class="btn btn-primary" onclick="loadTemplate('Economics')">Economics</button>
                        <button class="btn btn-primary" onclick="loadTemplate('Science')">Science</button>
                        <button class="btn btn-primary" onclick="loadTemplate('Maths')">Maths</button>
                        <button class="btn btn-primary" onclick="loadTemplate('Hindi')">Hindi</button>
                    </div>
                </div>
                <div class="mt-4 text-center">
                    <button class="btn btn-primary" onclick="switchTab('questions')">
                        <i class="fas fa-arrow-right mr-2"></i> Next: Add Questions
                    </button>
                </div>
            </div>

            <div class="tab-content" id="questions-tab">
                <div class="form-group">
                    <label>Question Input:</label>
                    <div class="flex gap-2 mb-2">
                        <button class="btn btn-primary" onclick="showTextInput()">Text Question</button>
                        <label class="btn btn-primary cursor-pointer">
                            Upload Image/PDF
                            <input type="file" id="file-input" class="hidden" multiple accept=".png,.jpg,.jpeg,.pdf">
                        </label>
                    </div>
                    <div id="text-input-container" style="display: block;">
                        <textarea id="text-question" placeholder="Type your question here..." maxlength="1000" class="h-24 w-full"></textarea>
                        <div id="mcq-options-container" class="mt-2" style="display: none;">
                            <label>MCQ Options:</label>
                            <div class="space-y-2">
                                <div><label class="inline-block w-8">A:</label><input type="text" class="mcq-option-input w-full" maxlength="50"></div>
                                <div><label class="inline-block w-8">B:</label><input type="text" class="mcq-option-input w-full" maxlength="50"></div>
                                <div><label class="inline-block w-8">C:</label><input type="text" class="mcq-option-input w-full" maxlength="50"></div>
                                <div><label class="inline-block w-8">D:</label><input type="text" class="mcq-option-input w-full" maxlength="50"></div>
                            </div>
                        </div>
                        <button class="btn btn-primary mt-2" onclick="addTextQuestion()">Add Text Question</button>
                    </div>
                </div>
                <div class="mt-4 flex justify-between items-center">
                    <div class="form-group">
                        <label for="question-type-filter">Filter:</label>
                        <select id="question-type-filter" onchange="filterQuestions()">
                            <option value="all">All</option>
                            <option value="text">Text</option>
                            <option value="image">Image</option>
                        </select>
                    </div>
                    <span>Total Questions: <span id="question-count" class="font-bold text-d1b65c">0</span></span>
                </div>
                <div class="mt-4 flex flex-wrap gap-2 justify-center">
                    <button class="btn btn-secondary" onclick="switchTab('setup')"><i class="fas fa-arrow-left mr-2"></i> Back</button>
                    <button class="btn btn-secondary" onclick="clearAllQuestions()"><i class="fas fa-trash-alt mr-2"></i> Clear All</button>
                    <button class="btn btn-primary" onclick="exportQuestions()"><i class="fas fa-download mr-2"></i> Export</button>
                    <label class="btn btn-primary cursor-pointer">
                        <i class="fas fa-upload mr-2"></i> Import
                        <input type="file" id="import-input" class="hidden" accept=".json">
                    </label>
                    <button class="btn btn-primary" onclick="sortQuestions()"><i class="fas fa-sort mr-2"></i> Sort</button>
                    <button class="btn btn-primary" onclick="switchTab('preview')"><i class="fas fa-eye mr-2"></i> Preview</button>
                </div>
                <div id="question-list" class="mt-4"></div>
            </div>

            <div class="tab-content" id="preview-tab">
                <div class="flex flex-wrap gap-2 justify-center mb-4">
                    <button class="btn btn-secondary" onclick="switchTab('questions')"><i class="fas fa-arrow-left mr-2"></i> Back</button>
                    <button class="btn btn-primary" onclick="generateQuestionPaper()"><i class="fas fa-file-alt mr-2"></i> Generate Paper</button>
                    <button class="btn btn-primary" onclick="downloadPDF()"><i class="fas fa-file-pdf mr-2"></i> Download PDF</button>
                    <button class="btn btn-primary" onclick="downloadPNG()"><i class="fas fa-file-image mr-2"></i> Download PNG</button>
                    <button class="btn btn-primary" onclick="downloadAll()"><i class="fas fa-download mr-2"></i> Download All</button>
                </div>
                <div id="paper-preview" class="preview-container relative" style="display: none;">
                    <div class="zoom-controls">
                        <button class="btn btn-secondary" onclick="zoomPreview(1.1)">+</button>
                        <button class="btn btn-secondary" onclick="zoomPreview(0.9)">-</button>
                    </div>
                </div>
                <div id="preview-placeholder" class="text-center text-545454 p-4">
                    <p>No paper generated yet. Click "Generate Paper" to create your question paper.</p>
                </div>
            </div>
        </div>
    </div>

    <div id="crop-modal" class="modal">
        <div class="modal-content">
            <h2 class="text-xl font-semibold mb-4">Crop Image</h2>
            <img id="crop-image" class="w-full mb-4">
            <div class="flex justify-center gap-2">
                <button class="btn btn-primary" onclick="saveCroppedImage()">Save</button>
                <button class="btn btn-secondary" onclick="closeCrop()">Cancel</button>
            </div>
        </div>
    </div>

    <div id="pdf-selection-modal" class="modal">
        <div class="modal-content">
            <h2 class="text-xl font-semibold mb-4">Select PDF Pages</h2>
            <div id="pdf-pages" class="space-y-2"></div>
            <div class="flex justify-center gap-2 mt-4">
                <button class="btn btn-primary" onclick="saveSelectedPDFPages()">Save</button>
                <button class="btn btn-secondary" onclick="closePDFSelection()">Cancel</button>
            </div>
        </div>
    </div>

    <div id="options-modal" class="modal">
        <div class="modal-content">
            <h2 class="text-xl font-semibold mb-4">Add MCQ Options</h2>
            <div class="space-y-2">
                <div><label class="inline-block w-8">A:</label><input type="text" id="optionA" class="w-full p-2 rounded bg-545454" maxlength="50"></div>
                <div><label class="inline-block w-8">B:</label><input type="text" id="optionB" class="w-full p-2 rounded bg-545454" maxlength="50"></div>
                <div><label class="inline-block w-8">C:</label><input type="text" id="optionC" class="w-full p-2 rounded bg-545454" maxlength="50"></div>
                <div><label class="inline-block w-8">D:</label><input type="text" id="optionD" class="w-full p-2 rounded bg-545454" maxlength="50"></div>
            </div>
            <div class="flex justify-center gap-2 mt-4">
                <button class="btn btn-primary" onclick="saveOptions()">Save</button>
                <button class="btn btn-secondary" onclick="closeOptionsModal()">Cancel</button>
            </div>
        </div>
    </div>

    <div id="loading" class="loading-screen">
        <div class="loading-container">
            <div class="loading-text">Processing...</div>
            <div class="spinner"></div>
        </div>
    </div>

    <div id="notification" class="notification hidden"></div>

    <footer class="text-center py-4 text-545454">
        <p>© <script>document.write(new Date().getFullYear());</script> Mangukiya Ved. All rights reserved.</p>
    </footer>

    <script>
        const { jsPDF } = window.jspdf;
        let questions = [], cropper = null, cropIndex = null, currentIndex = null, previewScale = 1, isPaperGenerated = false;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            try {
                document.getElementById('paperType').addEventListener('change', toggleMCQOptions);
                document.getElementById('file-input').addEventListener('change', handleFileUpload);
                document.getElementById('import-input').addEventListener('change', importQuestions);
                document.getElementById('fontStyle').addEventListener('change', () => {
                    updateFont();
                    if (isPaperGenerated) generateQuestionPaper();
                });
                document.getElementById('headerStyle').addEventListener('change', () => {
                    if (isPaperGenerated) generateQuestionPaper();
                });
                document.getElementById('paperStyle').addEventListener('change', () => {
                    if (isPaperGenerated) generateQuestionPaper();
                });
                document.querySelectorAll('.tab').forEach(tab => tab.addEventListener('click', () => switchTab(tab.getAttribute('data-tab'))));
                toggleMCQOptions();
                loadSavedData();
                updateStats();
                validateInputs();
                setInterval(autoSave, 300000);
                updateFont();
            } catch (error) {
                showNotification('Error initializing application', 'error');
                console.error(error);
            }
        });

        function validateInputs() {
            try {
                const inputs = document.querySelectorAll('input[required], select[required]');
                inputs.forEach(input => {
                    input.addEventListener('input', () => {
                        input.classList.toggle('invalid', !input.value.trim());
                    });
                    input.classList.toggle('invalid', !input.value.trim());
                });
            } catch (error) {
                showNotification('Error validating inputs', 'error');
                console.error(error);
            }
        }

        function toggleMCQOptions() {
            try {
                const paperType = document.getElementById('paperType').value;
                document.getElementById('mcq-options-container').style.display = (paperType === 'mcq' || paperType === 'mixed') ? 'block' : 'none';
            } catch (error) {
                showNotification('Error toggling MCQ options', 'error');
                console.error(error);
            }
        }

        function switchTab(tabId) {
            showLoading();
            try {
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
                document.getElementById(`${tabId}-tab`).classList.add('active');
                document.querySelector(`.tab[data-tab="${tabId}"]`).classList.add('active');
                if (tabId === 'questions') {
                    renderQuestionList();
                } else if (tabId === 'preview') {
                    document.getElementById('paper-preview').style.display = isPaperGenerated ? 'block' : 'none';
                    document.getElementById('preview-placeholder').style.display = isPaperGenerated ? 'none' : 'block';
                }
                hideLoading();
            } catch (error) {
                showNotification('Error switching tabs', 'error');
                hideLoading();
                console.error(error);
            }
        }

        function showTextInput() {
            try {
                document.getElementById('text-input-container').style.display = 'block';
            } catch (error) {
                showNotification('Error showing text input', 'error');
                console.error(error);
            }
        }

        function addTextQuestion() {
            showLoading();
            try {
                const text = document.getElementById('text-question').value.trim();
                const paperType = document.getElementById('paperType').value;
                const options = [];
                if (paperType === 'mcq' || paperType === 'mixed') {
                    const inputs = document.querySelectorAll('.mcq-option-input');
                    inputs.forEach((input, i) => {
                        if (input.value.trim()) options.push({ label: String.fromCharCode(65 + i), text: input.value.trim() });
                    });
                    if (options.length < 2) {
                        showNotification('Please add at least two options for MCQ', 'error');
                        hideLoading();
                        return;
                    }
                }

                if (!text) {
                    showNotification('Please enter a question', 'error');
                    hideLoading();
                    return;
                }

                questions.push({ type: 'text', question: text, options, isMCQ: options.length > 0, category: 'normal' });
                document.getElementById('text-question').value = '';
                document.querySelectorAll('.mcq-option-input').forEach(input => input.value = '');
                renderQuestionList();
                updateStats();
                showNotification('Question added successfully');
                autoSave();
                hideLoading();
            } catch (error) {
                showNotification('Error adding question', 'error');
                hideLoading();
                console.error(error);
            }
        }

        async function handleFileUpload(event) {
            const files = event.target.files;
            if (!files.length) return;
            showLoading();
            try {
                for (const file of files) {
                    if (file.type === 'application/pdf') {
                        const pdfUrl = URL.createObjectURL(file);
                        const loadingTask = pdfjsLib.getDocument({ url: pdfUrl });
                        const pdf = await loadingTask.promise;
                        const numPages = pdf.numPages;
                        const pagesContainer = document.getElementById('pdf-pages');
                        pagesContainer.innerHTML = '';

                        for (let i = 1; i <= numPages; i++) {
                            const page = await pdf.getPage(i);
                            const viewport = page.getViewport({ scale: 1.5 });
                            const canvas = document.createElement('canvas');
                            const context = canvas.getContext('2d');
                            canvas.height = viewport.height;
                            canvas.width = viewport.width;
                            await page.render({ canvasContext: context, viewport }).promise;
                            const imgData = canvas.toDataURL('image/png');

                            const pageDiv = document.createElement('div');
                            pageDiv.classList.add('p-2', 'border', 'border-454545', 'rounded', 'cursor-pointer', 'hover:border-d1b65c');
                            pageDiv.innerHTML = `<img src="${imgData}" alt="Page ${i}" class="w-full"><p class="text-center text-e9ecef mt-2">Page ${i}</p>`;
                            pageDiv.onclick = () => pageDiv.classList.toggle('bg-225686');
                            pagesContainer.appendChild(pageDiv);
                        }

                        document.getElementById('pdf-selection-modal').style.display = 'flex';
                    } else if (['image/png', 'image/jpeg'].includes(file.type)) {
                        const reader = new FileReader();
                        reader.onload = () => {
                            questions.push({ type: 'image', src: reader.result, options: [], isMCQ: false, category: 'normal' });
                            renderQuestionList();
                            updateStats();
                            showNotification('Image question added');
                            autoSave();
                        };
                        reader.readAsDataURL(file);
                    } else {
                        showNotification('Only PNG, JPEG, or PDF files allowed', 'error');
                    }
                }
                hideLoading();
            } catch (error) {
                showNotification('Error processing file', 'error');
                hideLoading();
                console.error(error);
            }
            event.target.value = '';
        }

        function saveSelectedPDFPages() {
            try {
                const selectedPages = document.querySelectorAll('#pdf-pages > div.bg-225686');
                if (!selectedPages.length) {
                    showNotification('Please select at least one page', 'error');
                    return;
                }

                selectedPages.forEach(page => {
                    const imgSrc = page.querySelector('img').src;
                    questions.push({ type: 'image', src: imgSrc, options: [], isMCQ: false, category: 'normal' });
                });

                renderQuestionList();
                updateStats();
                closePDFSelection();
                showNotification('PDF pages added');
                autoSave();
            } catch (error) {
                showNotification('Error saving PDF pages', 'error');
                console.error(error);
            }
        }

        function closePDFSelection() {
            try {
                document.getElementById('pdf-selection-modal').style.display = 'none';
                document.getElementById('pdf-pages').innerHTML = '';
            } catch (error) {
                showNotification('Error closing PDF selection', 'error');
                console.error(error);
            }
        }

        function openOptionsModal(index) {
            try {
                currentIndex = index;
                const opts = questions[index].options;
                document.getElementById('optionA').value = opts.find(o => o.label === 'A')?.text || '';
                document.getElementById('optionB').value = opts.find(o => o.label === 'B')?.text || '';
                document.getElementById('optionC').value = opts.find(o => o.label === 'C')?.text || '';
                document.getElementById('optionD').value = opts.find(o => o.label === 'D')?.text || '';
                document.getElementById('options-modal').style.display = 'flex';
            } catch (error) {
                showNotification('Error opening options modal', 'error');
                console.error(error);
            }
        }

        function saveOptions() {
            try {
                if (currentIndex === null) return;
                const options = [
                    { label: 'A', text: document.getElementById('optionA').value.trim() },
                    { label: 'B', text: document.getElementById('optionB').value.trim() },
                    { label: 'C', text: document.getElementById('optionC').value.trim() },
                    { label: 'D', text: document.getElementById('optionD').value.trim() }
                ].filter(opt => opt.text);

                if (options.length < 2) {
                    showNotification('Please add at least two options', 'error');
                    return;
                }

                questions[currentIndex].isMCQ = true;
                questions[currentIndex].options = options;
                closeOptionsModal();
                renderQuestionList();
                updateStats();
                showNotification('Options saved');
                autoSave();
            } catch (error) {
                showNotification('Error saving options', 'error');
                console.error(error);
            }
        }

        function closeOptionsModal() {
            try {
                document.getElementById('options-modal').style.display = 'none';
                document.getElementById('optionA').value = '';
                document.getElementById('optionB').value = '';
                document.getElementById('optionC').value = '';
                document.getElementById('optionD').value = '';
                currentIndex = null;
            } catch (error) {
                showNotification('Error closing options modal', 'error');
                console.error(error);
            }
        }

        function renderQuestionList() {
            try {
                const list = document.getElementById('question-list');
                const filter = document.getElementById('question-type-filter').value;
                list.innerHTML = '';

                if (!questions.length) {
                    list.innerHTML = '<p class="text-center text-545454">No questions added yet.</p>';
                    return;
                }

                const filteredQuestions = filter === 'all' ? questions : questions.filter(q => q.type === filter);
                const fragment = document.createDocumentFragment();

                filteredQuestions.forEach((q, index) => {
                    const questionDiv = document.createElement('div');
                    questionDiv.classList.add('question-container');
                    questionDiv.setAttribute('data-index', index);
                    questionDiv.draggable = true;

                    questionDiv.addEventListener('dragstart', e => {
                        questionDiv.classList.add('dragging');
                        e.dataTransfer.setData('text/plain', index);
                    });
                    questionDiv.addEventListener('dragend', () => questionDiv.classList.remove('dragging'));
                    questionDiv.addEventListener('dragover', e => e.preventDefault());
                    questionDiv.addEventListener('drop', e => {
                        e.preventDefault();
                        const sourceIndex = parseInt(e.dataTransfer.getData('text/plain'));
                        const targetIndex = index;
                        if (sourceIndex !== targetIndex) {
                            const [moved] = questions.splice(sourceIndex, 1);
                            questions.splice(targetIndex, 0, moved);
                            renderQuestionList();
                            showNotification('Question reordered');
                            autoSave();
                        }
                    });

                    const content = document.createElement('div');
                    content.classList.add('flex', 'items-center', 'gap-2');
                    content.innerHTML = `
                        <span class="font-bold text-d1b65c">Q${index + 1}</span>
                        ${q.type === 'image' ? `<img src="${q.src}" alt="Question Image" class="max-w-[100px] rounded">` : `<span class="bg-e9ecef text-333333 p-1 rounded text-sm">${q.question.substring(0, 50)}${q.question.length > 50 ? '...' : ''}</span>`}
                    `;
                    questionDiv.appendChild(content);

                    const btnGroup = document.createElement('div');
                    btnGroup.classList.add('flex', 'gap-2', 'mt-2');
                    btnGroup.innerHTML = `
                        <button class="btn btn-secondary" title="Drag to reorder"><i class="fas fa-grip-lines"></i></button>
                        <button class="btn btn-secondary" title="Delete" onclick="deleteQuestion(${index})"><i class="fas fa-trash"></i></button>
                        ${q.type === 'image' ? `
                            <button class="btn btn-primary" title="Crop" onclick="openCrop('${encodeURIComponent(q.src)}', ${index})"><i class="fas fa-crop-alt"></i></button>
                            <button class="btn btn-primary" title="Rotate" onclick="rotateImage(${index})"><i class="fas fa-redo"></i></button>
                        ` : ''}
                        <button class="btn btn-primary" title="Add Options" onclick="openOptionsModal(${index})"><i class="fas fa-plus"></i></button>
                    `;
                    questionDiv.appendChild(btnGroup);

                    if (q.isMCQ && q.options.length) {
                        const optionsDiv = document.createElement('div');
                        optionsDiv.classList.add('ml-4', 'mt-1', 'text-sm');
                        optionsDiv.innerHTML = q.options.map(opt => `<div>${opt.label}: ${opt.text.substring(0, 30)}${opt.text.length > 30 ? '...' : ''}</div>`).join('');
                        questionDiv.appendChild(optionsDiv);
                    }

                    fragment.appendChild(questionDiv);
                });

                list.appendChild(fragment);
            } catch (error) {
                showNotification('Error rendering question list', 'error');
                console.error(error);
            }
        }

        function filterQuestions() {
            try {
                renderQuestionList();
            } catch (error) {
                showNotification('Error filtering questions', 'error');
                console.error(error);
            }
        }

        function deleteQuestion(index) {
            try {
                if (confirm('Are you sure you want to delete this question?')) {
                    questions.splice(index, 1);
                    renderQuestionList();
                    updateStats();
                    showNotification('Question deleted');
                    autoSave();
                }
            } catch (error) {
                showNotification('Error deleting question', 'error');
                console.error(error);
            }
        }

        function clearAllQuestions() {
            try {
                if (!questions.length || confirm('Are you sure you want to clear all questions?')) {
                    questions = [];
                    renderQuestionList();
                    updateStats();
                    showNotification('All questions cleared');
                    autoSave();
                }
            } catch (error) {
                showNotification('Error clearing questions', 'error');
                console.error(error);
            }
        }

        function sortQuestions() {
            try {
                questions.sort((a, b) => {
                    if (a.type === 'text' && b.type === 'text') return a.question.localeCompare(b.question);
                    return a.type.localeCompare(b.type);
                });
                renderQuestionList();
                updateStats();
                showNotification('Questions sorted');
                autoSave();
            } catch (error) {
                showNotification('Error sorting questions', 'error');
                console.error(error);
            }
        }

        function updateStats() {
            try {
                document.getElementById('question-count').textContent = questions.length;
            } catch (error) {
                showNotification('Error updating stats', 'error');
                console.error(error);
            }
        }

        function openCrop(src, index) {
            try {
                cropIndex = index;
                const image = document.getElementById('crop-image');
                image.src = decodeURIComponent(src);
                document.getElementById('crop-modal').style.display = 'flex';
                image.onload = () => {
                    if (cropper) cropper.destroy();
                    cropper = new Cropper(image, { aspectRatio: NaN, viewMode: 1, dragMode: 'move', autoCropArea: 0.8, zoomable: true });
                };
                image.onerror = () => {
                    showNotification('Error loading image for cropping', 'error');
                    closeCrop();
                };
            } catch (error) {
                showNotification('Error opening crop modal', 'error');
                console.error(error);
            }
        }

        function saveCroppedImage() {
            showLoading();
            try {
                if (!cropper) {
                    showNotification('No image to crop', 'error');
                    hideLoading();
                    return;
                }
                const canvas = cropper.getCroppedCanvas({ maxWidth: 2048, maxHeight: 2048, fillColor: '#fff' });
                if (canvas) {
                    questions[cropIndex].src = canvas.toDataURL('image/jpeg', 0.8);
                    closeCrop();
                    renderQuestionList();
                    showNotification('Image cropped successfully');
                    autoSave();
                } else {
                    showNotification('Error cropping image', 'error');
                }
                hideLoading();
            } catch (error) {
                showNotification('Error saving cropped image', 'error');
                hideLoading();
                console.error(error);
            }
        }

        function closeCrop() {
            try {
                if (cropper) {
                    cropper.destroy();
                    cropper = null;
                }
                document.getElementById('crop-modal').style.display = 'none';
            } catch (error) {
                showNotification('Error closing crop modal', 'error');
                console.error(error);
            }
        }

        function rotateImage(index) {
            showLoading();
            try {
                const img = new Image();
                img.src = questions[index].src;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = img.height;
                    canvas.height = img.width;
                    ctx.translate(canvas.width / 2, canvas.height / 2);
                    ctx.rotate(Math.PI / 2);
                    ctx.drawImage(img, -img.width / 2, -img.height / 2);
                    questions[index].src = canvas.toDataURL('image/jpeg', 0.8);
                    renderQuestionList();
                    hideLoading();
                    showNotification('Image rotated successfully');
                    autoSave();
                };
                img.onerror = () => {
                    hideLoading();
                    showNotification('Error rotating image', 'error');
                };
            } catch (error) {
                showNotification('Error rotating image', 'error');
                hideLoading();
                console.error(error);
            }
        }

        function exportQuestions() {
            showLoading();
            try {
                const data = {
                    questions,
                    setup: {
                        schoolName: document.getElementById('schoolName').value,
                        subject: document.getElementById('subject').value,
                        chapter: document.getElementById('chapter').value,
                        examName: document.getElementById('examName').value,
                        marks: document.getElementById('marks').value,
                        duration: document.getElementById('duration').value,
                        examDate: document.getElementById('examDate').value,
                        paperType: document.getElementById('paperType').value,
                        headerStyle: document.getElementById('headerStyle').value,
                        paperStyle: document.getElementById('paperStyle').value,
                        fontStyle: document.getElementById('fontStyle').value
                    }
                };
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                saveAs(blob, `${data.setup.subject || 'QuestionPaper'}_data.json`);
                showNotification('Questions exported successfully');
                hideLoading();
            } catch (error) {
                showNotification('Error exporting questions', 'error');
                hideLoading();
                console.error(error);
            }
        }

        function importQuestions(event) {
            showLoading();
            try {
                const file = event.target.files[0];
                if (!file || !file.name.endsWith('.json')) {
                    showNotification('Please upload a valid JSON file', 'error');
                    hideLoading();
                    return;
                }

                const reader = new FileReader();
                reader.onload = () => {
                    try {
                        const data = JSON.parse(reader.result);
                        questions = (data.questions || []).map(q => ({ ...q, category: 'normal' }));
                        if (data.setup) {
                            document.getElementById('schoolName').value = data.setup.schoolName || '';
                            document.getElementById('subject').value = data.setup.subject || '';
                            document.getElementById('chapter').value = data.setup.chapter || '';
                            document.getElementById('examName').value = data.setup.examName || '';
                            document.getElementById('marks').value = data.setup.marks || '';
                            document.getElementById('duration').value = data.setup.duration || '';
                            document.getElementById('examDate').value = data.setup.examDate || '';
                            document.getElementById('paperType').value = data.setup.paperType || 'short';
                            document.getElementById('headerStyle').value = data.setup.headerStyle || 'traditional';
                            document.getElementById('paperStyle').value = data.setup.paperStyle || 'structured';
                            document.getElementById('fontStyle').value = data.setup.fontStyle || 'Times New Roman';
                            toggleMCQOptions();
                            updateFont();
                        }
                        renderQuestionList();
                        updateStats();
                        autoSave();
                        showNotification('Questions imported successfully');
                        hideLoading();
                    } catch (error) {
                        showNotification('Error importing file', 'error');
                        hideLoading();
                        console.error(error);
                    }
                };
                reader.readAsText(file);
                event.target.value = '';
            } catch (error) {
                showNotification('Error importing questions', 'error');
                hideLoading();
                console.error(error);
            }
        }

        function loadSavedData() {
            try {
                const saved = localStorage.getItem('questions');
                if (saved) {
                    const data = JSON.parse(saved);
                    questions = (data.questions || []).map(q => ({ ...q, category: 'normal' }));
                    if (data.setup) {
                        document.getElementById('schoolName').value = data.setup.schoolName || '';
                        document.getElementById('subject').value = data.setup.subject || '';
                        document.getElementById('chapter').value = data.setup.chapter || '';
                        document.getElementById('examName').value = data.setup.examName || '';
                        document.getElementById('marks').value = data.setup.marks || '';
                        document.getElementById('duration').value = data.setup.duration || '';
                        document.getElementById('examDate').value = data.setup.examDate || '';
                        document.getElementById('paperType').value = data.setup.paperType || 'short';
                        document.getElementById('headerStyle').value = data.setup.headerStyle || 'traditional';
                        document.getElementById('paperStyle').value = data.setup.paperStyle || 'structured';
                        document.getElementById('fontStyle').value = data.setup.fontStyle || 'Times New Roman';
                        toggleMCQOptions();
                        updateFont();
                    }
                    renderQuestionList();
                    updateStats();
                }
            } catch (error) {
                showNotification('Error loading saved data', 'error');
                console.error(error);
            }
        }

        function updateFont() {
            try {
                const fontStyle = document.getElementById('fontStyle').value;
                document.body.style.fontFamily = fontStyle;
                const preview = document.getElementById('paper-preview');
                if (preview) {
                    preview.style.fontFamily = fontStyle;
                }
            } catch (error) {
                showNotification('Error updating font', 'error');
                console.error(error);
            }
        }

        function renderHeader(schoolName, subject, chapter, marks, duration, examDate, examName, headerStyle) {
            try {
                const title = examName ? `${subject} - ${examName}` : subject;
                const styles = {
                    classic: `
                        <h1 class="paper-title">${schoolName || 'School: ________'}</h1>
                        <p class="paper-subtitle">${title}</p>
                        <p class="paper-subtitle">Subject: ${subject} | Chapter: ${chapter || 'N/A'} | Marks: ${marks} | Duration: ${duration} | Date: ${examDate}</p>
                    `,
                    modern: `
                        <h1 class="paper-title">${schoolName || 'School: ________'}</h1>
                        <h2 class="paper-subtitle">${title}</h2>
                        <p class="paper-subtitle">Subject: ${subject} | Chapter: ${chapter || 'N/A'} | Marks: ${marks} | Duration: ${duration} | Date: ${examDate}</p>
                    `,
                    minimal: `
                        <h1 class="paper-title">${schoolName || 'School: ________'}</h1>
                        <p class="paper-subtitle">${title}</p>
                        <p class="paper-subtitle">Marks: ${marks} | Duration: ${duration} | Date: ${examDate}</p>
                    `,
                    traditional: `
                        <h1 class="paper-title">${schoolName || 'School: ________'}</h1>
                        <p class="paper-subtitle">${title}</p>
                        <p class="paper-subtitle">Subject: ${subject} | Chapter: ${chapter || 'N/A'} | Marks: ${marks} | Duration: ${duration} | Date: ${examDate}</p>
                    `,
                    academic: `
                        <h1 class="paper-title">${schoolName || 'School: ________'}</h1>
                        <h2 class="paper-subtitle" style="text-align: right;">${title}</h2>
                        <p class="paper-subtitle">Subject: ${subject} | Chapter: ${chapter || 'N/A'} | Marks: ${marks} | Duration: ${duration} | Date: ${examDate}</p>
                    `
                };
                return `<div class="paper-header">${styles[headerStyle] || styles.traditional}</div>`;
            } catch (error) {
                showNotification('Error rendering header', 'error');
                console.error(error);
                return '';
            }
        }

        function renderPaperContent(questions, paperStyle) {
            try {
                let content = '<div class="paper-content" style="margin-top: 20mm;">';
                const numberStyles = {
                    standard: 'Q${i + 1}.',
                    compact: '${i + 1}.',
                    detailed: 'Question ${i + 1}:',
                    formal: 'Q${i + 1}:',
                    structured: 'Q${i + 1}.'
                };
                const numberStyle = numberStyles[paperStyle] || numberStyles.standard;

                questions.forEach((q, i) => {
                    content += `
                        <div class="paper-question">
                            <span class="question-number">${numberStyle.replace('${i + 1}', i + 1)}</span>
                            <div>
                                ${q.type === 'image' ? `<img src="${q.src}" alt="Question ${i + 1}" style="max-width: 100%;">` : `<span>${q.question}</span>`}
                                ${q.isMCQ && q.options.length ? `
                                    <div class="ml-4 mt-2">
                                        ${q.options.map(opt => `<div>${opt.label}. ${opt.text}</div>`).join('')}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                });
                content += '</div>';
                return content;
            } catch (error) {
                showNotification('Error rendering paper content', 'error');
                console.error(error);
                return '';
            }
        }

        function generateQuestionPaper() {
            showLoading();
            try {
                const preview = document.getElementById('paper-preview');
                const schoolName = document.getElementById('schoolName').value.trim();
                const subject = document.getElementById('subject').value.trim();
                const chapter = document.getElementById('chapter').value.trim();
                const examName = document.getElementById('examName').value.trim();
                const marks = document.getElementById('marks').value;
                const duration = document.getElementById('duration').value.trim();
                const examDate = document.getElementById('examDate').value ? new Date(document.getElementById('examDate').value).toLocaleDateString() : new Date().toLocaleDateString();
                const headerStyle = document.getElementById('headerStyle').value;
                const paperStyle = document.getElementById('paperStyle').value;
                const fontStyle = document.getElementById('fontStyle').value;

                if (!questions.length || !subject || !marks || !duration || !examDate) {
                    showNotification('Please fill all required fields and add at least one question', 'error');
                    switchTab('setup');
                    hideLoading();
                    return;
                }

                const headerHTML = renderHeader(schoolName, subject, chapter, marks, duration, examDate, examName, headerStyle);
                const contentHTML = renderPaperContent(questions, paperStyle);

                preview.style.fontFamily = fontStyle;
                preview.innerHTML = headerHTML + contentHTML;
                preview.style.display = 'block';
                document.getElementById('preview-placeholder').style.display = 'none';
                isPaperGenerated = true;
                showNotification('Question paper generated');
                hideLoading();
            } catch (error) {
                showNotification('Error generating paper', 'error');
                hideLoading();
                console.error(error);
            }
        }

        async function downloadPDF() {
            if (!isPaperGenerated) {
                showNotification('Please generate the paper first', 'error');
                return;
            }
            showLoading();
            try {
                const preview = document.getElementById('paper-preview');
                const pdf = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
                const pageWidth = pdf.internal.pageSize.getWidth();
                const pageHeight = pdf.internal.pageSize.getHeight();
                const margin = 10;

                let yPos = margin;
                const header = preview.querySelector('.paper-header');
                const headerCanvas = await html2canvas(header, { scale: 2, useCORS: true, backgroundColor: '#ffffff' });
                const headerImg = headerCanvas.toDataURL('image/jpeg', 0.8);
                const headerHeight = headerCanvas.height * ((pageWidth - 2 * margin) / headerCanvas.width);
                pdf.addImage(headerImg, 'JPEG', margin, yPos, pageWidth - 2 * margin, headerHeight);
                yPos += headerHeight + 5;

                const questionsDiv = preview.querySelector('.paper-content');
                const questionElems = questionsDiv.querySelectorAll('.paper-question');

                for (let i = 0; i < questionElems.length; i++) {
                    const question = questionElems[i];
                    const canvas = await html2canvas(question, { scale: 2, useCORS: true, backgroundColor: '#ffffff' });
                    const imgData = canvas.toDataURL('image/jpeg', 0.8);
                    const imgWidth = pageWidth - 2 * margin;
                    const imgHeight = canvas.height * (imgWidth / canvas.width);

                    if (yPos + imgHeight > pageHeight - margin) {
                        pdf.addPage();
                        yPos = margin;
                    }

                    pdf.addImage(imgData, 'JPEG', margin, yPos, imgWidth, imgHeight);
                    yPos += imgHeight + 5;
                }

                pdf.setFontSize(8);
                pdf.text(`Page ${pdf.internal.getNumberOfPages()} | © ${new Date().getFullYear()} unifyxproject.netlify.app`, pageWidth / 2, pageHeight - 5, { align: 'center' });
                pdf.save(`${document.getElementById('subject').value || 'Subject'}_QuestionPaper.pdf`);
                showNotification('PDF downloaded successfully');
                hideLoading();
            } catch (error) {
                showNotification('Error downloading PDF', 'error');
                hideLoading();
                console.error(error);
            }
        }

        async function downloadPNG() {
            if (!isPaperGenerated) {
                showNotification('Please generate the paper first', 'error');
                return;
            }
            showLoading();
            try {
                const preview = document.getElementById('paper-preview');
                const canvas = await html2canvas(preview, { scale: 2, useCORS: true, backgroundColor: '#ffffff' });
                canvas.toBlob(blob => {
                    saveAs(blob, `${document.getElementById('subject').value || 'Subject'}_QuestionPaper.png`);
                    showNotification('PNG downloaded successfully');
                    hideLoading();
                });
            } catch (error) {
                showNotification('Error downloading PNG', 'error');
                hideLoading();
                console.error(error);
            }
        }

        async function downloadAll() {
            if (!isPaperGenerated) {
                showNotification('Please generate the paper first', 'error');
                return;
            }
            showLoading();
            try {
                await downloadPDF();
                await downloadPNG();
                showNotification('All files downloaded successfully');
                hideLoading();
            } catch (error) {
                showNotification('Error downloading files', 'error');
                hideLoading();
                console.error(error);
            }
        }

        function zoomPreview(factor) {
            try {
                previewScale *= factor;
                previewScale = Math.max(0.2, Math.min(2, previewScale));
                document.getElementById('paper-preview').style.transform = `scale(${previewScale})`;
            } catch (error) {
                showNotification('Error zooming preview', 'error');
                console.error(error);
            }
        }

        function showNotification(message, type = 'success') {
            try {
                const notification = document.getElementById('notification');
                notification.textContent = message;
                notification.className = `notification ${type}`;
                notification.classList.remove('hidden');
                setTimeout(() => notification.classList.add('hidden'), 3000);
            } catch (error) {
                console.error('Error showing notification:', error);
            }
        }

        function showLoading() {
            try {
                const loading = document.getElementById('loading');
                loading.classList.remove('hidden');
                loading.classList.add('active');
            } catch (error) {
                console.error('Error showing loading screen:', error);
            }
        }

        function hideLoading() {
            try {
                const loading = document.getElementById('loading');
                loading.classList.remove('active');
                setTimeout(() => loading.classList.add('hidden'), 300);
            } catch (error) {
                console.error('Error hiding loading screen:', error);
            }
        }

        function loadTemplate(template) {
            try {
                const templates = {
                    'A/C': { schoolName: 'Sample School', subject: 'A/C', chapter: 'Financial Accounting', examName: 'Mid-Term', marks: '50', duration: '2 hours', examDate: '2025-05-10', paperType: 'mixed' },
                    'Economics': { schoolName: 'Sample School', subject: 'Economics', chapter: 'Microeconomics', examName: 'Semester-1', marks: '50', duration: '2 hours', examDate: '2025-06-15', paperType: 'mixed' },
                    'Science': { schoolName: 'Sample School', subject: 'Science', chapter: 'Physics', examName: 'Annual Exam', marks: '50', duration: '2 hours', examDate: '2025-04-20', paperType: 'short' },
                    'Maths': { schoolName: 'Sample School', subject: 'Maths', chapter: 'Algebra', examName: 'Unit Test', marks: '50', duration: '1.5 hours', examDate: '2025-05-05', paperType: 'mcq' },
                    'Hindi': { schoolName: 'Sample School', subject: 'Hindi', chapter: 'Literature', examName: 'Final Exam', marks: '50', duration: '2 hours', examDate: '2025-06-01', paperType: 'short' }
                };
                const data = templates[template] || {};
                document.getElementById('schoolName').value = data.schoolName || '';
                document.getElementById('subject').value = data.subject || '';
                document.getElementById('chapter').value = data.chapter || '';
                document.getElementById('examName').value = data.examName || '';
                document.getElementById('marks').value = data.marks || '';
                document.getElementById('duration').value = data.duration || '';
                document.getElementById('examDate').value = data.examDate || '';
                document.getElementById('paperType').value = data.paperType || 'short';
                toggleMCQOptions();
                showNotification(`${template} template loaded`);
                autoSave();
                if (isPaperGenerated) generateQuestionPaper();
            } catch (error) {
                showNotification('Error loading template', 'error');
                console.error(error);
            }
        }

        function autoSave() {
            try {
                const data = {
                    questions,
                    setup: {
                        schoolName: document.getElementById('schoolName').value,
                        subject: document.getElementById('subject').value,
                        chapter: document.getElementById('chapter').value,
                        examName: document.getElementById('examName').value,
                        marks: document.getElementById('marks').value,
                        duration: document.getElementById('duration').value,
                        examDate: document.getElementById('examDate').value,
                        paperType: document.getElementById('paperType').value,
                        headerStyle: document.getElementById('headerStyle').value,
                        paperStyle: document.getElementById('paperStyle').value,
                        fontStyle: document.getElementById('fontStyle').value
                    }
                };
                localStorage.setItem('questions', JSON.stringify(data));
            } catch (error) {
                showNotification('Error saving data', 'error');
                console.error(error);
            }
        }
    </script>
</body>
</html>